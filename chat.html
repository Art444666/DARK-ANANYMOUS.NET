<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Telegram Anonymous Chat</title>
  <script src="https://cdn.socket.io"></script>
  <style>
    :root {
      --bg-dark: #0e1621;
      --bg-side: #17212b;
      --accent: #5288c1;
      --text: #f5f5f5;
      --msg-out: #2b5278;
      --msg-in: #182533;
      --anim: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body, html { height: 100%; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-dark); color: var(--text); overflow: hidden; }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .app-wrap { display: flex; height: 100vh; width: 100vw; }

    /* --- SIDEBAR --- */
    .sidebar { width: 320px; background: var(--bg-side); display: flex; flex-direction: column; border-right: 1px solid #080a0d; position: relative; }
    .header-tools { padding: 15px; display: flex; align-items: center; gap: 12px; }
    .search-input { flex: 1; background: #242f3d; border: none; border-radius: 20px; padding: 10px 15px; color: white; outline: none; }
    
    .rooms-list { flex: 1; overflow-y: auto; }
    .room-item { padding: 12px 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s; }
    .room-item:hover { background: #232e3c; }
    .room-item.active { background: var(--msg-out); }
    .room-item.hidden { display: none; }

    /* –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è (FAB) */
    .fab { position: absolute; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--accent); color: white; border: none; font-size: 24px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: 0.3s; z-index: 10; }
    .fab:hover { transform: scale(1.1) rotate(90deg); }

    /* --- CHAT AREA --- */
    .chat-area { flex: 1; display: flex; flex-direction: column; position: relative; background: #0e1621; }
    .chat-header { background: var(--bg-side); padding: 10px 20px; display: flex; align-items: center; gap: 15px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; list-style: none; margin: 0; }
    
    /* –°–æ–æ–±—â–µ–Ω–∏—è */
    .msg-bubble { max-width: 75%; padding: 8px 14px; border-radius: 12px; font-size: 15px; animation: slideUp 0.2s ease; word-wrap: break-word; position: relative; }
    .msg-bubble.mine { align-self: flex-end; background: var(--msg-out); border-bottom-right-radius: 2px; }
    .msg-bubble.other { align-self: flex-start; background: var(--msg-in); border-bottom-left-radius: 2px; }
    .msg-bubble.system { align-self: center; background: rgba(255,255,255,0.1); font-size: 12px; border-radius: 15px; opacity: 0.8; }

    .input-bar { background: var(--bg-side); padding: 15px; display: flex; gap: 10px; align-items: center; }
    .send-btn { background: none; border: none; color: var(--accent); cursor: pointer; font-size: 22px; }

    /* --- DRAWER (–ú–ï–ù–Æ) --- */
    .drawer { position: fixed; left: -310px; top: 0; width: 300px; height: 100%; background: var(--bg-side); z-index: 1000; transition: var(--anim); padding: 25px; box-sizing: border-box; }
    .drawer.open { left: 0; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; z-index: 999; }

    /* –£—á–∞—Å—Ç–Ω–∏–∫–∏ */
    .user-panel { position: absolute; right: -250px; top: 60px; width: 240px; background: var(--bg-side); height: calc(100% - 60px); transition: var(--anim); border-left: 1px solid #080a0d; padding: 15px; z-index: 50; }
    .user-panel.open { right: 0; }

    .avatar { width: 45px; height: 45px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-weight: bold; }
  </style>
</head>
<body>

<div class="overlay" id="overlay" onclick="closeAll()"></div>

<!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
<div class="drawer" id="drawer">
  <h2 style="color: var(--accent)">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
  <p>–í—ã: <strong>{{ username }}</strong></p>
  <button class="send-btn" style="font-size: 14px; color: #ff6b6b;" onclick="adminAction()">üîë –í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É</button>
</div>

<div class="app-wrap">
  <div class="sidebar">
    <div class="header-tools">
      <div style="cursor:pointer; font-size: 22px;" onclick="toggleDrawer()">‚ò∞</div>
      <input type="text" class="search-input" id="search" placeholder="–ü–æ–∏—Å–∫..." oninput="filterRooms()">
    </div>
    
    <div class="rooms-list" id="roomsContainer"></div>
    <button class="fab" onclick="createRoomPrompt()">+</button>
  </div>

  <div class="chat-area">
    <div class="chat-header" onclick="toggleUsers()">
      <div class="avatar" id="chatAvatar">?</div>
      <div style="flex:1">
        <div id="activeRoomName" style="font-weight:600">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É</div>
        <div id="roomSub" style="font-size:12px; color:gray">–∏–Ω—Ñ–æ –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö</div>
      </div>
    </div>
    
    <div id="chat"></div>

    <div class="input-bar" id="inputSection" style="display: none;">
      <input type="text" id="msg" class="search-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMessage()">
      <button class="send-btn" onclick="sendMessage()">‚û§</button>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —é–∑–µ—Ä–æ–≤ -->
    <div class="user-panel" id="userPanel">
      <h4 style="margin-top:0">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏</h4>
      <ul id="userlist" style="padding:0; list-style:none; font-size:14px;"></ul>
      <hr style="border:0.5px solid #242f3d">
      <div id="ownerinfo" style="font-size:12px; color:var(--accent)"></div>
    </div>
  </div>
</div>

<script>
  const socket = io();
  const myUsername = "{{ username }}";
  let currentRoom = null;

  // --- –õ–û–ì–ò–ö–ê –ò–ó –¢–í–û–ï–ì–û –ö–û–î–ê ---

  socket.on("room_list", list => {
    const container = document.getElementById("roomsContainer");
    container.innerHTML = "";
    list.forEach(room => {
      const isPrivate = room.includes("[–ø—Ä–∏–≤–∞—Ç]");
      const cleanName = room.replace(" [–ø—Ä–∏–≤–∞—Ç]", "").trim();
      const div = document.createElement("div");
      div.className = "room-item";
      div.dataset.name = cleanName;
      div.onclick = () => {
        let password = isPrivate ? prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è " + cleanName) : "";
        socket.emit("join_room", { room: cleanName, password });
      };
      div.innerHTML = `
        <div class="avatar" style="background:${isPrivate ? '#4a3d4d' : '#5288c1'}">${cleanName[0].toUpperCase()}</div>
        <div>
          <div style="font-weight:600">${cleanName} ${isPrivate ? 'üîê' : ''}</div>
          <div style="font-size:12px; color:gray">–Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏</div>
        </div>
      `;
      container.appendChild(div);
    });
  });

  socket.on("room_joined", room => {
    currentRoom = room;
    document.getElementById("activeRoomName").innerText = room;
    document.getElementById("chatAvatar").innerText = room[0].toUpperCase();
    document.getElementById("inputSection").style.display = "flex";
    document.getElementById("chat").innerHTML = "";
    closeAll();
  });

  socket.on("message", msg => {
    const chat = document.getElementById("chat");
    const div = document.createElement("div");
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ —Å–≤–æ–µ
    if (!msg.includes(":")) {
      div.className = "msg-bubble system";
    } else {
      const author = msg.split(":")[0].trim();
      div.className = `msg-bubble ${author === myUsername ? 'mine' : 'other'}`;
    }
    
    div.textContent = msg;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  });

  socket.on("userlist", data => {
    const ul = document.getElementById("userlist");
    ul.innerHTML = "";
    data.users.forEach(u => {
      const li = document.createElement("li");
      li.style.padding = "5px 0";
      li.textContent = (u === data.owner ? "üëë " : "‚Ä¢ ") + u;
      ul.appendChild(li);
    });
    document.getElementById("ownerinfo").innerHTML = `–í–ª–∞–¥–µ–ª–µ—Ü: <b>${data.owner}</b>`;
    document.getElementById("roomSub").innerText = `${data.users.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
  });

  // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï UI ---

  function sendMessage() {
    const input = document.getElementById("msg");
    if(input.value.trim()) {
      socket.send(input.value);
      input.value = "";
    }
  }

  function createRoomPrompt() {
    const room = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã:");
    if (room) {
      const password = prompt("–ü–∞—Ä–æ–ª—å (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–æ–π):");
      socket.emit("create_room", { room, password });
    }
  }

  function adminAction() {
    const pass = prompt("–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:");
    if (pass === "94488") {
      socket.emit("admin_login", { password: pass });
    } else {
      alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
    }
  }

  function filterRooms() {
    const q = document.getElementById("search").value.toLowerCase();
    document.querySelectorAll(".room-item").forEach(item => {
      item.classList.toggle("hidden", !item.dataset.name.toLowerCase().includes(q));
    });
  }

  function toggleDrawer() {
    document.getElementById("drawer").classList.toggle("open");
    document.getElementById("overlay").style.display = "block";
  }

  function toggleUsers() {
    document.getElementById("userPanel").classList.toggle("open");
  }

  function closeAll() {
    document.getElementById("drawer").classList.remove("open");
    document.getElementById("userPanel").classList.remove("open");
    document.getElementById("overlay").style.display = "none";
  }

  socket.on("room_error", msg => alert(msg));
  socket.on("admin_success", msg => alert("–£—Å–ø–µ—Ö: " + msg));
</script>
</body>
</html>






