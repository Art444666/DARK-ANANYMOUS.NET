<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram X Anonymous</title>
    <script src="https://cdn.socket.io"></script>
    <style>
        :root {
            --bg-dark: #0e1621; --bg-side: #17212b; --accent: #5288c1;
            --text: #f5f5f5; --msg-out: #2b5278; --msg-in: #182533;
            --glass: rgba(23, 33, 43, 0.75); --anim: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body, html { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg-dark); color: var(--text); overflow: hidden; }

        /* --- –ò–ó–Æ–ú–ò–ù–ö–ê: –û–ë–û–ò –ò –≠–§–§–ï–ö–¢–´ --- */
        .chat-area { 
            flex: 1; display: flex; flex-direction: column; position: relative;
            background: #0e1621 url('https://www.transparenttextures.com');
            transition: var(--anim);
        }
        
        /* –°—Ç–µ–∫–ª—è–Ω–Ω—ã–π —Ö–µ–¥–µ—Ä */
        .chat-header { 
            background: var(--glass); backdrop-filter: blur(15px); padding: 10px 20px;
            display: flex; align-items: center; gap: 15px; z-index: 10;
            border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer;
        }

        /* --- –°–û–û–ë–©–ï–ù–ò–Ø (–ü–£–ó–´–†–ò) --- */
        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .msg { 
            max-width: 75%; padding: 8px 14px; border-radius: 15px; font-size: 15px;
            animation: msgPop 0.3s ease; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .mine { align-self: flex-end; background: var(--msg-out); border-bottom-right-radius: 2px; }
        .other { align-self: flex-start; background: var(--msg-in); border-bottom-left-radius: 2px; }
        .system { align-self: center; background: rgba(255,255,255,0.1); font-size: 12px; border-radius: 20px; padding: 4px 12px; }
        
        .chat-img { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; }
        @keyframes msgPop { from { opacity: 0; transform: translateY(10px) scale(0.95); } }

        /* --- SIDEBAR --- */
        .app-wrap { display: flex; height: 100vh; }
        .sidebar { width: 320px; background: var(--bg-side); display: flex; flex-direction: column; border-right: 1px solid #000; position: relative; }
        
        .room-item { 
            padding: 12px; margin: 4px 10px; border-radius: 12px; display: flex; align-items: center; gap: 12px; 
            cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        }
        .room-item:hover { background: rgba(255,255,255,0.05); }
        .room-item.active { background: var(--accent); border-color: rgba(255,255,255,0.1); }
        .room-item.hidden { display: none; }

        .avatar { 
            width: 48px; height: 48px; border-radius: 50%; background: var(--accent);
            display: flex; align-items: center; justify-content: center; font-weight: bold; position: relative;
        }
        .online-dot { width: 12px; height: 12px; background: #4caf50; border-radius: 50%; border: 2px solid var(--bg-side); position: absolute; bottom: 0; right: 0; }

        /* --- –ö–ù–û–ü–ö–ò –ò –í–í–û–î --- */
        .fab { 
            position: absolute; bottom: 20px; right: 20px; width: 56px; height: 56px; 
            border-radius: 50%; background: var(--accent); border: none; color: white;
            font-size: 28px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.4); transition: 0.3s;
        }
        .fab:hover { transform: scale(1.1) rotate(90deg); }

        .input-bar { background: var(--glass); backdrop-filter: blur(20px); padding: 12px; display: flex; align-items: center; gap: 12px; }
        .inp { flex: 1; background: #242f3d; border: none; padding: 10px 15px; border-radius: 20px; color: white; outline: none; }

        /* --- DRAWER (–ú–ï–ù–Æ) --- */
        .drawer { position: fixed; left: -310px; top: 0; width: 300px; height: 100%; background: var(--bg-side); z-index: 1000; transition: var(--anim); padding: 25px; box-sizing: border-box; }
        .drawer.open { left: 0; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; z-index: 999; backdrop-filter: blur(2px); }
    </style>
</head>
<body>

<div class="overlay" id="overlay" onclick="closeDrawer()"></div>

<!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
<div class="drawer" id="drawer">
    <h2 style="color: var(--accent)">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
    <div style="margin-bottom: 20px;">
        <label style="font-size: 12px; color: gray;">–í–ê–® –ù–ò–ö</label>
        <input type="text" id="nickEdit" class="inp" style="width:100%; margin-top:5px;" value="{{ username }}">
        <button onclick="updateProfile()" style="margin-top:10px; background:var(--accent); border:none; padding:8px; width:100%; border-radius:8px; color:white; cursor:pointer;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <hr style="border: 0.5px solid #242f3d">
    <button onclick="adminPanel()" style="background:none; border:none; color:#ff6b6b; cursor:pointer; padding:0;">üîë –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</button>
</div>

<div class="app-wrap">
    <!-- SIDEBAR -->
    <div class="sidebar">
        <div style="padding: 15px; display: flex; align-items: center; gap: 10px;">
            <div style="cursor:pointer; font-size: 22px;" onclick="openDrawer()">‚ò∞</div>
            <input type="text" class="inp" placeholder="–ü–æ–∏—Å–∫..." oninput="filterRooms(this.value)">
        </div>
        <div id="roomsContainer" style="flex:1; overflow-y:auto"></div>
        <button class="fab" onclick="createRoom()">+</button>
    </div>

    <!-- CHAT AREA -->
    <div class="chat-area">
        <div class="chat-header">
            <div class="avatar" id="h-av" style="width:40px; height:40px">?</div>
            <div style="flex:1">
                <div id="h-name" style="font-weight:bold">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
                <div id="h-online" style="font-size:12px; color:var(--accent)">–≤ —Å–µ—Ç–∏: 0</div>
            </div>
        </div>

        <div id="chat"></div>

        <div class="input-bar" id="inputBox" style="display: none;">
            <input type="file" id="imgInp" hidden accept="image/*" onchange="uploadImg(this)">
            <button onclick="document.getElementById('imgInp').click()" style="background:none; border:none; color:var(--accent); cursor:pointer; font-size:20px;">üìé</button>
            <input type="text" id="msg" class="inp" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') send()">
            <button onclick="send()" style="background:none; border:none; color:var(--accent); font-size:22px; cursor:pointer;">‚û§</button>
        </div>
    </div>
</div>

<script>
    const socket = io();
    const myName = "{{ username }}";

    // --- –õ–û–ì–ò–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ---
    function send() {
        const i = document.getElementById("msg");
        if(i.value.trim()) { socket.send(i.value); i.value = ""; }
    }

    function uploadImg(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => socket.emit("message", `IMAGE_DATA:${e.target.result}`);
            reader.readAsDataURL(input.files[0]);
        }
    }

    socket.on("message", (data) => {
        const chat = document.getElementById("chat");
        const div = document.createElement("div");
        
        if (!data.includes(":")) {
            div.className = "msg system";
            div.textContent = data;
        } else {
            const [author, ...textParts] = data.split(":");
            const text = textParts.join(":");
            const isMine = author.trim() === myName;
            div.className = `msg ${isMine ? 'mine' : 'other'}`;
            
            if (text.includes("IMAGE_DATA:")) {
                const b64 = text.split("IMAGE_DATA:")[1];
                div.innerHTML = `<small style="color:var(--accent)">${author}</small><img src="${b64}" class="chat-img">`;
            } else {
                div.innerHTML = `<small style="color:var(--accent)">${author}</small><br>${text}`;
            }
        }
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    });

    // --- –ö–û–ú–ù–ê–¢–´ –ò –û–ù–õ–ê–ô–ù ---
    socket.on("room_list", (list) => {
        const cont = document.getElementById("roomsContainer");
        cont.innerHTML = "";
        list.forEach(r => {
            const isPrivate = r.includes("[–ø—Ä–∏–≤–∞—Ç]");
            const name = r.replace(" [–ø—Ä–∏–≤–∞—Ç]", "");
            const div = document.createElement("div");
            div.className = "room-item";
            div.dataset.name = name;
            div.onclick = () => socket.emit("join_room", { room: name, password: isPrivate ? prompt("–ü–∞—Ä–æ–ª—å:") : "" });
            div.innerHTML = `<div class="avatar">${name[0].toUpperCase()}<div class="online-dot"></div></div>
                             <div><b>${name} ${isPrivate ? 'üîê' : ''}</b><br><small style="color:gray">–Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—Ö–æ–¥–∞</small></div>`;
            cont.appendChild(div);
        });
    });

    socket.on("room_joined", (name) => {
        document.getElementById("h-name").innerText = name;
        document.getElementById("h-av").innerText = name[0].toUpperCase();
        document.getElementById("inputBox").style.display = "flex";
        document.getElementById("chat").innerHTML = "";
    });

    socket.on("userlist", (data) => {
        document.getElementById("h-online").innerText = `–≤ —Å–µ—Ç–∏: ${data.online_count || data.users.length}`;
    });

    // --- –ú–ï–ù–Æ ---
    function openDrawer() { document.getElementById("drawer").classList.add("open"); document.getElementById("overlay").style.display = "block"; }
    function closeDrawer() { document.getElementById("drawer").classList.remove("open"); document.getElementById("overlay").style.display = "none"; }
    
    function createRoom() {
        const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞:");
        if(n) socket.emit("create_room", { room: n, password: prompt("–ü–∞—Ä–æ–ª—å (–ø—É—Å—Ç–æ –¥–ª—è –≤—Å–µ—Ö):") });
    }

    function filterRooms(val) {
        document.querySelectorAll(".room-item").forEach(i => {
            i.classList.toggle("hidden", !i.dataset.name.toLowerCase().includes(val.toLowerCase()));
        });
    }

    function adminPanel() {
        const p = prompt("–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞:");
        if(p === "94488") socket.emit("admin_login", { password: p });
    }
</script>
</body>
</html>








